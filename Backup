#!ps
#timeout=30000000

# Get current username
$userName = (Get-WmiObject -Class Win32_ComputerSystem).username -replace '^.*\\'

# Set 7-Zip executable path
$7zipPath = "$env:ProgramFiles\7-Zip\7z.exe"
if (-not (Test-Path -Path $7zipPath -PathType Leaf)) {
    throw "7-Zip file '$7zipPath' not found"
}

# Check for running Firefox process and terminate it
$firefoxProcesses = Get-Process -Name firefox -ErrorAction SilentlyContinue
if ($firefoxProcesses) {
    Write-Host "Firefox is running. Terminating process..."
    Stop-Process -Name firefox -Force
    Start-Sleep -Seconds 3  # Wait a few seconds to ensure the process is fully stopped
}

# Set 7-Zip alias
Set-Alias Start-SevenZip $7zipPath

# Define Firefox profile source path
$Source = "C:\Users\$userName\AppData\Roaming\Mozilla\Firefox\Profiles"

# Detect OneDrive folder dynamically
$oneDriveFolder = Get-ChildItem -Path "C:\Users\$userName" -Directory |
    Where-Object { $_.Name -like "OneDrive*" } |
    Select-Object -First 1

if (-not $oneDriveFolder) {
    throw "OneDrive folder not found under C:\Users\$userName"
}

# Build backup zip target path
$Target = Join-Path $oneDriveFolder.FullName "browser-backup-script-test\browserscriptfirefox.zip"

# Get ESR Firefox profiles
$esrSource = Get-ChildItem -Path $Source -Filter "*-esr" -Directory

# Archive each ESR profile using 7-Zip
foreach ($esrFolder in $esrSource) {
    $esrFolderPath = $esrFolder.FullName
    Start-SevenZip a -mx=9 $Target $esrFolderPath
}
