#!ps
#timeout=30000000
$userName = (Get-WmiObject -class Win32_ComputerSystem ).username -replace '^.*\\'
$7zipPath = "$env:ProgramFiles\7-Zip\7z.exe"

if (-not (Test-Path -Path $7zipPath -PathType Leaf)) {
    throw "7 zip file '$7zipPath' not found"
}

# Check for running Firefox process and terminate it
$firefoxProcesses = Get-Process -Name firefox -ErrorAction SilentlyContinue
if ($firefoxProcesses) {
    Write-Host "Firefox is running. Terminating process..."
    Stop-Process -Name firefox -Force
    Start-Sleep -Seconds 3  # Wait a few seconds to ensure the process is fully stopped
}

Set-Alias Start-SevenZip $7zipPath

$Source = "C:\Users\$userName\AppData\Roaming\Mozilla\Firefox\Profiles"
$Target = "C:\Users\$userName\OneDrive - Guidepoint\browser-backup-script\browserscriptfirefox.zip"
$esrSource = Get-ChildItem -Path $Source -Filter "*-esr" -Directory

foreach ($esrFolder in $esrSource) {
    $esrFolderPath = $esrFolder.FullName
    Start-SevenZip a -mx=9 $Target $esrFolderPath
}
